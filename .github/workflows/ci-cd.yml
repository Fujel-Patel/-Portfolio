name: Professional CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  NODE_VERSION: '20'

jobs:
  # =========================================================================
  # 1. VERIFY STAGE (Linting, Formatting, Typecheck, Testing)
  # =========================================================================
  verify:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§¹ Run Linter (ESLint)
        run: npm run lint

      - name: ðŸŽ¨ Check Formatting (Prettier)
        run: npm run format:check

      - name: ðŸ” Type Check (TypeScript)
        run: npm run typecheck

      - name: ðŸ§ª Run Unit & Component Tests (Vitest)
        run: npm run test -- --run

  # =========================================================================
  # 2. DEPLOYMENT STAGE (Vercel)
  # =========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: verify # This ensures it ONLY deploys if ALL tests pass!
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ðŸŒ Pull Vercel Environment Info
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build Project via Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Deployed successfully to: $url"

  # =========================================================================
  # 3. PREVIEW DEPLOYMENT (For Pull Requests)
  # =========================================================================
  deploy-preview:
    name: Deploy Preview URL
    runs-on: ubuntu-latest
    needs: verify # Only deploy preview if code quality checks pass
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ðŸŒ Pull Vercel Environment Info
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build Project via Vercel
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy Preview to Vercel
        id: preview
        run: |
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Comment PR with URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Tests Passed & Preview Ready!**\n\nðŸ”— **URL:** ${{ steps.preview.outputs.url }}\n\n*Commit: \`${{ github.sha }}\`*`
            })
